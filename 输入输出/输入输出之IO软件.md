# 输入输出之IO软件

## 中断

<img src="..\images\image-20240309102506937.png" alt="image-20240309102506937" style="zoom:67%;" />

当一个设备完成工作向控制器发送中断信号，控制器将中断信号发给CPU，CPU进行中断。

中断控制器中有一个标识（中断向量表），用来指定发送中断的是哪个设备；还可以获取程序计数器

当CPU在处理一个中断信号的时候，又来了一个优先级更高的中断信号，那么正在处理的中断信号就挂起，此时被挂起的中断的当前状态信息保存到哪里？中断也可以看成一个小的进程或线程

​	一种是保存到中断控制器中的寄存器，让中断向量表来读取（寄存器有大小限制）

​	一种是保存到内存（堆栈）上，尽管内存资源稀缺，但是中断延迟非常短，这种方式也有问题：设备访问的是用户空间的内存，处理中断是操作系统在内核态的

### 精确中断和不精确中断

使机器处于良好状态的中断称为精确中断。这样的中断具有四个属性：

​	程序计数器保存在一个已知的地方

​	程序计数器指向的指令之前所有的指令已经完全执行

​	程序计数器指向的指令之后所有的指令都没有执行

​	程序计数器指向的指令的执行状态是已知的

不满足以上要求的中断称为不精确中断

## I/O软件原理

### I/O软件的目标

设备独立性

错误处理

同步和异步传输

缓冲

共享和独占

### 设备独立性

我们能够编写访问任何设备的应用程序，而不用事先指定特定的设备（比如主机连接显示器，不管是哪个牌子的显示器都可以连接，而不用为每一个品牌的显示器编写独属于它的程序）

与设备独立性密切相关的一个指标就是统一命名

### 错误处理

出现错误的时候，设备控制器会先处理，如果设备控制器处理不了，设备驱动程序再处理，如果都解决不了，就会把错误向上抛到硬件层面

### 同步和异步传输

**同步传输**：数据以块或帧传输，双方具有同步时钟，时钟的作用是传出数据之后，等待一个时钟周期，在这一个周期内会一直等待对方的反馈，如果周期结束，对方没有发送反馈，那么我再重新发送

**异步传输**：数据以字节会字符传输，双方没有同步时钟，在传输之前会添加奇偶校验位，发送数据之后不会再等待反馈

同步传输的应用场景：视频通话，电话，逻辑IO（缓冲区）

异步传输的应用场景：邮件，物理IO（实实在在的设备之间的传输）

### 缓冲

通常情况下，从一个设备发出的数据不会直接到达最后的设备。期间会经过一系列的校验，检查，缓冲等操作才会到达

### 共享和独占

有些IO设备能够被许多用户共同使用。比如磁盘

某些设备必须具有独占性，只允许单个用户使用完成后才能让其他用户使用

## 软件控制I/O设备的方法

使用程序控制I/O

使用中断驱动I/O

使用DMA驱动I/O

### 使用程序控制I/O

使用程序控制I/O又被称为可编程I/O，由CPU在驱动程序软件的控制下启动的数据传输，来访问设备上的寄存器或者其他存储器，缺陷是CPU需要等待

### 使用中断驱动I/O

中断当前的状态并保存当前的状态去执行其他操作

中断的基本操作：

​	CPU进行读取操作

​	I/O设备从外围设备获取数据，同时CPU在执行着其他操作

​	I/O设备中断通知CPU

​	CPU请求数据

​	I/O模块传输数据

缺陷：如果传输大量数据，并且逐字传输，会大大降低CPU的执行效率

### 使用DMA驱动I/O

DMA是直接内存访问，CPU把IO模块的全部权限给到DMA，CPU不管了，CPU只需要知道自己什么时候需要中断（也就是DMA对于IO的读取操作完成了）这个过程由称为DMA控制器（DMAC）的芯片管理

DMA设备可以直接在内存之间传输数据，不需要CPU作为中介，因此可以缓解总线上的拥塞



